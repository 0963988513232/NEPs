---
NEP: 371
Title: Runtime Function Call Access Key Info
Author: Ben Kurrek <ben.kurrek@near.org>
DiscussionsTo: https://gov.near.org/t/expose-gas-price-and-contract-access-key-info-within-runtime/24788
Status: Draft
Type: Standards Track
Category: Contract
Created: 13-Jul-2022
---

## Summary

There is currently no way to query for information about function call access keys stored on your contract at runtime.

## Motivation

As contracts start to use access keys in more creative ways, developers will want to know information such as the access key's allowance, receiver and more. Since contracts are often built for scalability, Gas and storage costs are often delegated to the end user. If you charge the user for an access key and its allowance, when the key is deleted or used up, that allowance should be refunded to the purchaser. Currently, there is no way to query for the leftover allowance before a key is deleted. This information can tell you how much Gas was spent, and allows for a slew of different scenarios to arise.

## Rationale and alternatives

Without creating a promise, we can only query for information stored on the same shard. This is why in this proposal, the access key information at runtime will only come from keys stored on the current contract. We had also investigated the possibility of introducing pagination for all keys stored on the contract but this is infeasible at the moment due to the significant redesign requirement of the VM logic. In addition, we have thought about introducing a way to query for full access key information but this didn't seem useful and we can always add it in another NEP.

## Specification

In the runtime, function call access key information will be queryable via a function by passing in the desired public key. The key information will be of the following form.

```js
type FunctionCallKeyInfo = {
    public_key: string,
    nonce: number,
    receiver_id: string,
    allowance: string,
    method_names: Array<string>,
}
```

This information should be queryable via a new function called `function_call_key_info_for_current_contract` which takes a public key as a parameter.

```ts
function function_call_key_info_for_current_contract(
  public_key: &PublicKey,
): FunctionCallKeyInfo | null
```

This function should be exposed in the environment and callable using `env::function_call_key_info_for_current_contract();`. An example of this can be seen below.

```rs
pub fn check_key_exists(&self, pk: PublicKey) {
    let key_info: FunctionCallKeyInfo = env::function_call_key_info_for_current_contract(&pk);

    if let Some(info) = key_info {
        near_sdk::log!("key info found");
    } else {
        near_sdk::log!("No public key found");
    }
}
```

An example of returning the allowance of the key can be seen below.

```rs
pub fn check_key_allowance(&self, pk: PublicKey) {
    let key_info: FunctionCallKeyInfo = env::function_call_key_info_for_current_contract(&pk).unwrap();

    let allowance = fc.allowance;
    near_sdk::log!("key allowance: {}", allowance);
}
```

## Future possibilities

There were several future possibilities we had discussed and decided it would be best to start small and expand in the future if there was public interest. One of which was the ability to query for full access key information as well. In addition, adding the ability to check the type of key as either full access or function call access would allow for an interesting slew of use-cases.

We had also discussed the idea of paginating through keys on the contract and returning a vector of `FunctionCallKeyInfo`, or full access key info. In addition, we could add a `key_total_supply` function that returns the number of access keys stored on the contract. We had also thought of allowing 


One could also expand and introduce the ability to query for access key info from other contracts by using a promise.

## Copyright
[copyright]: #copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
